name: Publish to pub.dev

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Ensure tag matches pubspec version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          PACKAGE_VERSION="$(grep '^version:' pubspec.yaml | head -n1 | awk '{print $2}')"
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$PACKAGE_VERSION" ]; then
            echo "Could not read version from pubspec.yaml"
            exit 1
          fi
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match pubspec version ($PACKAGE_VERSION)."
            exit 1
          fi
          echo "Publishing version $PACKAGE_VERSION"

      - name: Analyze
        run: flutter analyze

      - name: Run tests
        run: flutter test

      - name: Publish dry-run
        run: flutter pub publish --dry-run

      - name: Ensure version is not already published
        run: |
          PACKAGE_NAME="$(grep '^name:' pubspec.yaml | head -n1 | awk '{print $2}')"
          PACKAGE_VERSION="$(grep '^version:' pubspec.yaml | head -n1 | awk '{print $2}')"
          if [ -z "$PACKAGE_NAME" ] || [ -z "$PACKAGE_VERSION" ]; then
            echo "Failed to parse package name/version from pubspec.yaml."
            exit 1
          fi
          if curl -fsSL "https://pub.dev/api/packages/$PACKAGE_NAME" | grep -q "\"version\":\"$PACKAGE_VERSION\""; then
            echo "Version $PACKAGE_VERSION is already published on pub.dev."
            echo "Bump pubspec.yaml version and create a new tag."
            exit 1
          fi

      - name: Configure pub.dev token
        env:
          PUB_TOKEN: ${{ secrets.PUB_TOKEN }}
        run: |
          if [ -z "${PUB_TOKEN:-}" ]; then
            echo "Missing PUB_TOKEN secret in GitHub Actions."
            exit 1
          fi
          dart pub token add https://pub.dev --env-var PUB_TOKEN

      - name: Publish to pub.dev
        run: flutter pub publish --force
